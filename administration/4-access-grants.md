Access Grants
=============

Let's do an example case. Say we want to allow our API Server to access PostgreSQL database named `blog`. We want to use PostgreSQL role named `foo_apiserver` and the API Server cluster is in network `192.168.100.0/24`.

There are several configuration that you need to pay attention to to grant the grants.

# pg_hba.conf

As mentioned before this file configures something like internal firewall for PostgreSQL.

By default, PostgreSQL allows OS user named `postgres` to connect as `postgres` super user in PostgreSQL. You can find the line that allows this in `pg_hba.conf`

```
local   all             postgres                                peer
```

`pg_hba.conf` has 5 columns format

1. The first column is the connection type. `local` means connection through local unix-socket.

2. The second column is the allowed database to be connected to. `all` means connections to all databases are allowed.

3. The third column is the user. `postgres` means connections started by `postgres` user.

4. The fourth column is the optional source address. If it's omitted there is no source address check.

5. The fifth column is the authentication method. `peer` means authentication through OS user. This means that `postgres` user in the OS can connect to PostgreSQL.

So the whole line tells: connection through local unix socket by postgres user from the os is allowed to connect to all databases.

Usually this `pg_hba.conf` grant is used by database administrator to connect to the PostgreSQL instance.

For further explanation please check https://www.postgresql.org/docs/13/auth-pg-hba-conf.html

For our case, we will need to add this line to `pg_hba.conf`

```
host blog foo_apiserver 192.168.100.0/24 md5
```

The `foo_apiserver` role will authenticate itself using md5 auth method. This will be configured on the next section.

# Database Roles

Run `psql` as `postgres` user:

```
sudo su postgres
psql
```

Then create role with:

```
create role foo_apiserver with login password 'md5bfcee46f5df7d47c7fe4c24176c1d13d';
```

The password is generated by:

`"md5" + md5("PASSWORD" + "ROLENAME")`

Above password has was generated with `PASSWORD=foo` and `ROLENAME=foo_apiserver`.

Please check https://www.postgresql.org/docs/13/sql-createrole.html for further role creation options.

# Granting role to access database

Still in `psql`, run:

```
grant all privileges on database blog to foo_apiserver;
```

Please check https://www.postgresql.org/docs/13/sql-grant.html for further grants options.
